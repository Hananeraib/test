image: docker:20.10.16
# image: docker:dind
variables:
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: "vps-da62cdaf.vps.ovh.net:8082/pfeblog"
services:
  - name: docker:dind
    # alias: docker
    #Add our registry to insecure registry group
    command: ["--insecure-registry=vps-da62cdaf.vps.ovh.net:8082"]
default:
  tags:
    - docker-simple

stages:
  - build
  - deploy

build_backend:
  stage: build
  before_script:
  - docker login -u $REGISTRY_USERNAME -p "$REGISTRY_PASSWORD" vps-da62cdaf.vps.ovh.net:8082/artifactory/pfeblog/
  script:
    - cd ./django
    - echo "hello"
    - docker build -t $REGISTRY/backend:latest -t .
    - docker push $REGISTRY/backend:latest 
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
      changes:
        - django/**/* 

build_frontend:
  stage: build
  before_script:
  - docker ps -a
  - docker login -u $REGISTRY_USERNAME -p "$REGISTRY_PASSWORD" vps-da62cdaf.vps.ovh.net:8082/artifactory/pfeblog/
  script:
    - cd ./react/blogapi
    - echo "hello"
    - docker build -t $REGISTRY/frontend:latest .
    - docker push $REGISTRY/frontend:latest 
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
      changes:
        - react/blogapi/**/* 

deploy:
  stage: deploy
  tags:
    - ansible
  script:
    - ansible --version
    - ansible-playbook copydockercompose.yml
    - ansible-playbook production.play.yml
  when: manual
  allow_failure: false  #To no skip the first stages and not run when there's a failure
  only:
    - dev