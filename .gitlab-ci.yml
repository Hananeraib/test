image: docker:20.10.16
variables:
  DOCKER_TLS_CERTDIR: ""
services:
  - name: docker:dind
    #Add our registry to insecure registry group
    command: ["--insecure-registry=vps-da62cdaf.vps.ovh.net:8082"]
default:
  tags:
    - docker

stages:
  - build
  - deploy

# build:
#   stage: build
#   before_script:
#   - docker login -u $REGISTRY_USERNAME -p "$REGISTRY_PASSWORD" vps-da62cdaf.vps.ovh.net:8082/artifactory/pfeblog/
#   script:
#     - docker compose build
#     - docker compose push
build_backend:
  stage: build
  before_script:
  - docker login -u $REGISTRY_USERNAME -p "$REGISTRY_PASSWORD" vps-da62cdaf.vps.ovh.net:8082/artifactory/pfeblog/
  script:
    - cd ./react/blogapi
    - docker build -t vps-da62cdaf.vps.ovh.net:8082/pfeblog/frontend:latest .
    - docker push vps-da62cdaf.vps.ovh.net:8082/pfeblog/frontend:latest 
  only:
    changes:
      - ./react/blogapi/*
  #   - dev

deploy:
  stage: deploy
  tags:
    - ansible
  script:
    # # - ansible --version
    # - ansible-playbook copydockercompose.yml
    # - ansible-playbook production.play.yml
    - echo $(pwd)
  when: manual